<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link href="/main.css" rel="stylesheet">
</head>

<body class="grey-bg">
    <div class="nav">
        <div class="date">
            <form action="/date" method="GET" class="form">
                <input type="date" id="date" name="date">
                <button type="submit" onclick="sendDate()">ì„ íƒ</button>
            </form>
            <input class="search"><button class="search-send">ê²€ìƒ‰</button>
        </div>
        <div class="goals">
            <h1>ì˜¤ëŠ˜ì˜ í•œë§ˆë””: ê·¸ëŸ´ ìˆ˜ ìˆì§€!</h1>
        </div>
        <!-- <div class="login-btn">
            <button type="button" onclick="location.href='login'">ë¡œê·¸ì¸</button>
        </div> -->
    </div>

    <div class="container">
        <!-- MyPage -->
        <div class="list-bg">
            <div class="profile">
                <img class="profile-image"
                    src="<%= userresult && userresult ? userresult.imgurl : '/uploads/profile.png' %>">
                <h3>
                    <%= userresult && userresult ? userresult.nickname : '' %>
                </h3>
                <h5>
                    <%= userresult && userresult.introduce ? userresult.introduce : 'ì†Œê°œê¸€ì„ ì ì–´ì£¼ì„¸ìš”.' %>
                </h5>
                <div class="profile-bottom">
                    <a href="/mypage">ìˆ˜ì •</a>
                </div>
            </div>

        </div>

        <!-- ì¼ì •ê´€ë¦¬ -->
        <div class="list-bg">
            <div class="title">
                <div class="title-a"><a href="/write">ê¸€ì“°ê¸°</a></div>
                <h2>ì¼ì •ê´€ë¦¬</h2>
            </div>
            <% for(let i=0;i<posts.length;i++) { %>
                <div class="list-box">
                    <h4>
                        <% if(posts[i].check==true) { %>
                            <h4 onclick="handleCheckClick('<%=posts[i]._id%>', this)">â­•</h4>
                            <% } else { %>
                                <h4 onclick="handleCheckClick('<%=posts[i]._id%>', this)">âŒ</h4>
                                <% } %>
                                    <%= posts[i].contents %>
                                        </a>
                                        <!-- ìˆ˜ì •ë²„íŠ¼ -->
                                        <a href="/edit/<%=posts[i]._id%>">âœï¸</a>

                                        <!-- ì‚­ì œë²„íŠ¼ -->
                                        <span class="delete" data-id="<%=posts[i]._id%>">ğŸ—‘ï¸</span>
                    </h4>
                </div>
                <% } %>
        </div>

        <!-- todoë¦¬ìŠ¤íŠ¸ -->
        <div class="list-bg">
            <div class="title">
                <div class="title-a"><a href="/todowrite">ê¸€ì“°ê¸°</a></div>
                <h2>Todoë¦¬ìŠ¤íŠ¸</h2>
            </div>
            <% for(let i=0;i<todos.length;i++) { %>
                <div class="list-box">
                    <h4>
                        <% if(todos[i].check==true) { %>
                            <h4 onclick="handleCheckClick('<%=todos[i]._id%>', this)">â­•</h4>
                            <% } else { %>
                                <h4 onclick="handleCheckClick('<%=todos[i]._id%>', this)">âŒ</h4>
                                <% } %>
                                    <%= todos[i].todo %>
                                        </a>
                                        <!-- ìˆ˜ì •ë²„íŠ¼ -->
                                        <a href="/edit/<%=todos[i]._id%>">âœï¸</a>

                                        <!-- ì‚­ì œë²„íŠ¼ -->
                                        <span class="delete2" data-id="<%=todos[i]._id%>">ğŸ—‘ï¸</span>
                    </h4>
                </div>
                <% } %>
        </div>

    </div>
</body>
<script>
    for (let i = 0; i < '<%= posts.length %>'; i++) {
        document.querySelectorAll('.delete')[i]
            .addEventListener('click', function (e) {
                fetch('delete?docid=' + e.target.dataset.id, { method: "DELETE" })
                    .then((r) => r.text())
                    .then((r) => { e.target.parentElement.style.display = 'none' })
            })
    }

    for (let i = 0; i < '<%= todos.length %>'; i++) {
        document.querySelectorAll('.delete2')[i]
            .addEventListener('click', function (e) {
                fetch('delete?docid=' + e.target.dataset.id, { method: "DELETE" })
                    .then((r) => r.text())
                    .then((r) => { e.target.parentElement.style.display = 'none' })
            })
    }

    // check ìƒíƒœ ë³€í™˜
    function handleCheckClick(id, element) {
        fetch(`/check/${id}`, { method: "PUT" })
            .then((r) => r.text())
            .then((e) => {
                // console.log("check: "+e)
                if (e === "true") {
                    element.innerText = "â­•"
                } else {
                    element.innerText = "âŒ"
                }
            })
    }

    // ì„ íƒí•œ ë‚ ì§œ ë°˜í™˜
    function sendDate() {
        // ì„ íƒëœ ë‚ ì§œë¥¼ ê°€ì ¸ì˜¤ê¸°
        const date = document.getElementById('date').value;
        const dateControl = document.querySelector('input[type="date"]')
        dateControl.value = date

        // ì„œë²„ë¡œ ë°ì´í„°ë¥¼ ì „ì†¡í•˜ê¸° ìœ„í•´ Fetch APIë¥¼ ì‚¬ìš©í•˜ì—¬ GET ìš”ì²­ ë³´ë‚´ê¸°
        fetch(`date/${date}`, {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json'
            }
        })
            .then((r) => r.text())
            .then((e) => {
                if (e === 'not result data') {
                    const listBox = document.querySelector('.list-box');
                    listBox.textContent = 'ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.';
                } else {
                    console.log("Response: " + e); // ë°˜í™˜ëœ ì‘ë‹µì„ ì½˜ì†”ì— ì¶œë ¥
                }

            })
    }

    document.querySelector('.search-send').addEventListener('click', function() {
        let inputWord = document.querySelector('.search').value
        location.href = '/search?val=' + inputWord
    })
</script>

</html>